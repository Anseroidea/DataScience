---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE, echo=FALSE}
require(knitr)
#setwd("C:/Users/slhscs402/Documents/IdeaProjects/DataScience/data")
#knitr::opts_knit$set(root.dir = "C:/Users/aidan/IdeaProjects/DataScience/data")
setwd("C:/Users/slhscs402/Documents/IdeaProjects/DataScience/data")
knitr::opts_knit$set(root.dir = "C:/Users/slhscs402/Documents/IdeaProjects/DataScience/data")
```

```{r}
#setwd("C:/Users/slhscs402/Documents/IdeaProjects/DataScience/data")
Clothing.df <- read.csv("Clothing.csv", header=T)
attach(Clothing.df)
```

*Removing people without relevant or accurate amounts*
```{r}
Clothing.df <- Clothing.df[Amount > 0 & Amount < 1000000,]
detach()
attach(Clothing.df)
```

*Condition plots for linear regression*
```{r}
linreg.conditionplots <- function(linreg){
  plot(linreg$fitted.values + linreg$residuals~linreg$fitted.values, ylab="Response", xlab="Fitted values", main = "Response by Fitted values") #filler plot to appease par's 2x2
  hist(linreg$residuals, xlab="Residuals", main="Histogram of residuals") #histogram of residuals
  plot(linreg$residuals~linreg$fitted.values, xlab="Fitted values", ylab="Residuals") #resid plot of residuals vs fitted values
  qqnorm(linreg$residuals) #the qqnorm plot of the residuals
  qqline(linreg$residuals)
}
```

## Finding a model

Let's try every column as a predictor.

```{r}
linreg1 <- lm(Amount~.-Amount,data=Clothing.df)
summary(linreg1)
```

Here, we see that only Freq12 and Dollar12 are significant. The $R_{adj}^2$ is 0.8689, for future reference.

Now, let's solely use the significant predictors

```{r}
linreg2 <- lm(Amount ~ Freq12 + Dollar12)
summary(linreg2)
```

$R_{adj}^2$ decreased a bit, but the fact that's its relatively the same means that the other predictors were probably not relevant. However, we can try better. Let's use a full second order model with Freq12 and Dollar12

```{r}
linreg3 <- lm(Amount~Freq12*Dollar12)
summary(linreg3)
```

Although $R_{adj}^2$ increased by a minuscule amount, the Freq12:Dollar12 predictor does not seem to be statistically significant (P > 0.05). Another useful predictor may be Card. First, let's see if there is a significant difference in Amount spent between card-holders and non card-holders.

```{r}
boxplot(Clothing.df[Clothing.df$Card==0,]$Amount, Clothing.df[Clothing.df$Card==1,]$Amount, col = c("red","blue"), names = c("Cardless", "Cardful"))
t.test(Clothing.df[Clothing.df$Card==0,]$Amount, Clothing.df[Clothing.df$Card==1,]$Amount)
```

Maybe the average spent per trip (Dollar12/Freq12) will be useful as a predictor

```{r}
Clothing.df.f12NZ <- Clothing.df[Freq12 > 0,]
detach()
attach(Clothing.df.f12NZ)
linreg4 <- lm(Amount ~ Freq12 + Dollar12 + I(Dollar12/Freq12))
summary(linreg4)
```

That's pretty significant! (p-value of Dollar12/Freq12 is tiny!). Since both the p-values Freq12 and Dollar12 increased, possibly some of Freq12 and Dollar12 can be expressed in Dollar12/Freq12

Also, screw it, let's use every combination of predictor

```{r}
attach(Clothing.df)
linreg5 <- lm(Amount ~ polym(Dollar12, Freq12, degree = 2))
summary(linreg5)
```

The output above shows all the interaction terms that are possible in a full second order model (excluding when a predictor is multiplied by itself). Let's solely pick the predictors significant at a = 0.001.

**
```{r}
linregtest <- lm(Amount ~ Dollar12 + Freq12)
multreg.testpredictors <- function(df, linreg, alpha) {
  formula <- 0
  for (index in seq_along(summary(linreg)$aliased)) {
    name <- names(summary(linreg)$aliased)[index]
    pval <- as.numeric(summary(linreg)$coefficients[name, 4])
    summary(linreg)
    if (grepl("poly", name, fixed=TRUE)) {
      name_list <- unlist(stringr::str_split(name, "\\(|\\)"))
      variable_names <- unlist(stringr::str_split(name_list[2], "\\, "))
      degrees <- unlist(stringr::str_split(name_list[3], "\\."))
      var_formula <- 0
      for (var_index in seq_along(variable_names)){
        if (var_index < length(variable_names)) {
          if (var_formula == 0) {
            var_formula <- paste0("I(", paste0(variable_names[var_index], "^", degrees[var_index]))
          } else {
            var_formula <- paste(var_formula, "*", paste0(variable_names[var_index], "^", degrees[var_index]))
          }
        }
      }
      name <- paste0(var_formula, ")")
    }
    if (pval < alpha & index > 1){
      if (formula == 0) {
        formula <- paste(names(linreg$model)[1], "~", name)
      } else {
        formula <- paste(formula, "+", name)
      }
    }
  }
  if (formula == 0){

  } else {
    linreg.red <- lm(formula, data = df)
    return(linreg.red)
  }
}
summary(linreg5)
anova(multreg.testpredictors(Clothing.df, linreg5, 0.05), linreg5)
linreg6 <- lm(Amount ~ . - Freq12 - Freq24 - Recency - Dollar24 - Card + I((Dollar12/Freq12)^2) + I(Dollar12 ^2) + I(Freq12 ^ 2) + I(Recency ^ 2) + I(Dollar24 ^ 2) + I(Freq24 ^ 2) + I(ID ^ 2) + I(Card ^ 2), data = Clothing.df)
```
```